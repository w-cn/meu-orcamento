<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Orçamento Pessoal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff; --success-color: #28a745; --info-color: #17a2b8;
            --danger-color: #dc3545; --header-bg: #6c757d; --body-bg: #f8f9fa;
            --container-bg: #ffffff; --text-color: #343a40; --border-color: #dee2e6;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--body-bg); color: var(--text-color); margin: 0; padding: 10px; }
        .container { max-width: 1200px; margin: auto; background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1, h2, h3 { text-align: center; color: var(--primary-color); }
        h1 { font-size: 2em; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #f1f1f1; padding-bottom: 10px; margin-top: 30px; }
        .tab-container { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab-container button { flex: 1; background-color: #f1f1f1; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 17px; font-weight: bold; color: #555; border-bottom: 3px solid transparent; }
        .tab-container button:hover { background-color: #e9ecef; }
        .tab-container button.active { background-color: white; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .tab-content { display: none; padding: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; vertical-align: middle; }
        th { background-color: var(--header-bg); color: white; position: relative; text-align: center; }
        tfoot td { background-color: #e9ecef; font-weight: bold; }
        input[type="number"], input[type="text"], select { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        .button-container { text-align: center; margin: 20px 0; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        button { background-color: var(--success-color); color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        button:hover { opacity: 0.9; }
        #importBtn { background-color: var(--info-color); } #exportBtn { background-color: var(--primary-color); }
        #resetBtn { background-color: var(--danger-color); }
        .action-btn-subtle { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.2em; padding: 0 8px; }
        .card { background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.07); }
        #statusPanel, #globalStatusPanel { color: white; font-size: 1.1em; text-align: center; }
        #statusPanel strong, #globalStatusPanel strong { font-size: 1.5em; display: inline-block; margin-left: 10px; }
        .status-green-strong { background: linear-gradient(45deg, #198754, #28a745); } .status-green-light { background: linear-gradient(45deg, #28a745, #5cb85c); }
        .status-yellow { background: linear-gradient(45deg, #ffc107, #ffdb5b); color: #343a40 !important; } .status-orange { background: linear-gradient(45deg, #fd7e14, #ff9f40); }
        .status-red { background: linear-gradient(45deg, #dc3545, #e74c3c); }
        .global-status-positive { background: linear-gradient(45deg, #0d6efd, #0dcaf0); }
        .global-status-negative { background: linear-gradient(45deg, #dc3545, #fd7e14); }
        #reportContainer details { border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 10px; }
        #reportContainer summary { list-style: none; display: flex; justify-content: space-between; align-items: center; padding: 12px; font-weight: bold; cursor: pointer; background-color: #f8f9fa; }
        #reportContainer summary::-webkit-details-marker { display: none; }
        #reportContainer summary::before { content: '+'; font-size: 1.5em; margin-right: 10px; color: var(--primary-color); }
        #reportContainer details[open] summary { background-color: #e9ecef; border-bottom: 1px solid var(--border-color); }
        #reportContainer details[open] summary::before { content: '−'; }
        .report-details-content { display: flex; flex-wrap: wrap; padding: 15px; gap: 20px; }
        .report-details-content > div { flex: 1; min-width: 250px; }
        .report-balance-positive { color: var(--success-color); } .report-balance-negative { color: var(--danger-color); }
        ul { list-style-type: none; padding-left: 0; } li { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed #eee; }
        .table-responsive-wrapper { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .controls-container { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; cursor: pointer; }
        .add-item-btn { width: 100%; height: 100%; background: none; border: none; color: white; font-size: 1.5em; }
        #chartContainer { position: relative; height: 45vh; width: 90%; max-width: 900px; margin: auto; }
        .footer-credit { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color); color: #888; font-style: italic; }
        .th-content-wrapper { display: flex; flex-direction: column; gap: 4px; justify-content: center; align-items: center; }
        .header-actions { display: flex; gap: 5px; height: 20px; }
        .item-action-btn { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; width: 20px; height: 20px; line-height: 20px; text-align: center; cursor: pointer; padding: 0; font-size: 0.9em; }
        .item-action-btn.delete-btn { font-size: 1.2em; }
        .item-action-btn:hover { background: rgba(0,0,0,0.2); }

        @media (max-width: 768px) {
            body { padding: 5px; } .container { padding: 10px; } h1 { font-size: 1.5em; } h2 { font-size: 1.2em; }
            .tab-container { flex-wrap: wrap; } .tab-container button { flex-basis: 50%; font-size: 14px; }
            th, td { padding: 8px 5px; font-size: 14px; min-width: 100px; }
            #expensesHeader tr th:first-child,
            #expensesBody tr td:first-child { position: -webkit-sticky; position: sticky; left: 0; z-index: 2; background-color: var(--header-bg); }
            #expensesBody tr td:first-child { background-color: var(--container-bg); z-index: 1; font-weight: bold; }
            #expensesTable { border-collapse: separate; }
            .controls-container { flex-direction: column; gap: 10px; }
            .modal-content { width: 95%; margin: 20% auto; }
            .button-container button { font-size: 14px; padding: 8px 12px; }
            #chartContainer { height: 60vh; width: 100%; min-height: 300px; }
            #expenseChart { max-width: 100%; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Meu Orçamento Pessoal</h1>
    <div class="tab-container">
        <button class="tab-link active" onclick="openTab(event, 'tabContas')" id="defaultOpen">Lançar Despesas</button>
        <button class="tab-link" onclick="openTab(event, 'tabOrcamento')">Orçamento</button>
        <button class="tab-link" onclick="openTab(event, 'tabRelatorio')">Relatório</button>
        <button class="tab-link" onclick="openTab(event, 'tabGraficos')">Gráficos</button>
    </div>
    <div id="tabContas" class="tab-content">
        <div class="controls-container"><label>Ver despesas de:</label><select id="expenseCategoryFilter" onchange="buildExpensesTable()"></select></div>
        <div id="globalStatusPanel" class="card" style="display: none;"></div>
        <div id="statusPanel" class="card">Carregando status...</div>
        <div style="text-align: right; margin: -10px 0 10px 0;"><label><input type="checkbox" id="showAllMonths" onchange="buildExpensesTable()"> Mostrar todos os meses</label></div>
        <div class="table-responsive-wrapper"><table id="expensesTable"><thead id="expensesHeader"></thead><tbody id="expensesBody"></tbody></table></div>
    </div>
    <div id="tabOrcamento" class="tab-content">
        <div class="controls-container"><label>Ano: <select id="yearSelectorBudget" onchange="handleYearChange()"></select></label><label>Mês: <select id="monthSelector" onchange="displayMonthDetails()"></select></label></div>
        <div style="text-align: right; margin: -15px 0 10px 0;"><label><input type="checkbox" id="applyToAllMonthsBudget"> Aplicar a todos os meses</label></div>
        <hr>
        <h2>Receitas</h2><table id="incomeTable"><thead><tr><th>Fonte de Renda</th><th>Valor (R$)</th><th style="width: 5%;">Ação</th></tr></thead><tbody></tbody></table><div class="button-container"><button onclick="addIncomeSource()">+ Adicionar Receita</button></div>
        <h2>Divisão do Orçamento (Categorias)</h2><table id="budgetTable"><thead><tr><th>Categoria</th><th>%</th><th>Valor (R$)</th><th style="width: 5%;">Ação</th></tr></thead><tbody id="budgetBody"></tbody><tfoot><tr><td>Total</td><td id="totalPercentage"></td><td id="totalMonth"></td><td></td></tr></tfoot></table><div class="button-container"><button onclick="addBudgetCategory()">+ Adicionar Categoria</button></div>
    </div>
    <div id="tabRelatorio" class="tab-content">
        <div class="controls-container"><label>Ano: <select id="yearSelectorReport" onchange="generateAnnualReport()"></select></label><label>Visão: <select id="reportViewSelector" onchange="generateAnnualReport()"><option value="byCategory">Por Categoria</option><option value="general">Geral de Despesas</option></select></label></div>
        <h2 id="reportYearTitle"></h2><div id="annual-summary-box" class="card"></div><div id="reportContainer"></div>
    </div>
    <div id="tabGraficos" class="tab-content">
        <div id="chartControlsContainer" class="controls-container">
            <label>Ano: <select id="yearSelectorChart"></select></label>
            <label>Período: <select id="chartPeriodSelector"></select></label>
            <label>Orçamento: <select id="chartCategorySelector"></select></label>
            <label>Tipo de Gráfico: <input type="radio" id="pieChart" name="chartType" value="pie" checked> Pizza <input type="radio" id="barChart" name="chartType" value="bar"> Barras</label>
        </div>
        <div id="chartContainer"><canvas id="expenseChart"></canvas></div>
    </div>
    <div class="button-container">
        <button id="importBtn" onclick="document.getElementById('importModal').style.display='block'">Importar / Modelo</button>
        <button id="exportBtn" onclick="exportToExcel()">Exportar Dados</button>
        <button id="resetBtn" onclick="resetAllData()">Resetar Dados</button>
    </div>
    <div class="footer-credit">by: Wendel Carvalho</div>
</div>
<div id="importModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="document.getElementById('importModal').style.display='none'">×</span><h3>Importar Dados</h3><p>Use o modelo para garantir que os dados sejam importados corretamente.</p><button onclick="downloadExcelTemplate()">1. Baixar Modelo</button><hr style="margin: 20px 0;"><label for="importFile" style="font-weight: bold;">2. Selecionar arquivo:</label><input type="file" id="importFile" accept=".xlsx, .xls" style="margin-top: 10px;"><div class="button-container" style="justify-content: flex-end;"><button onclick="importFromExcel()" style="background-color: var(--primary-color);">Importar</button></div></div></div>
<script>
let appData = {};
const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
let expenseChartInstance = null;
const categoryColorPalette = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#6c757d'];

document.addEventListener('DOMContentLoaded', () => {
    loadData();
    setupSelectors();
    document.getElementById("defaultOpen").click();
    
    document.getElementById('tabOrcamento').addEventListener('input', e => {
        if (e.target.tagName === 'INPUT') updateAllFromBudgetTab();
    });

    document.getElementById('chartControlsContainer').addEventListener('change', renderChart);

    window.onclick = e => {
        if (e.target.classList.contains('modal')) e.target.style.display = "none";
    };
});

function openTab(event, tabName) {
    document.querySelectorAll(".tab-content").forEach(t => t.style.display = "none");
    document.querySelectorAll(".tab-container button").forEach(b => b.classList.remove("active"));
    document.getElementById(tabName).style.display = "block";
    event.currentTarget.classList.add("active");

    if (tabName === 'tabRelatorio') generateAnnualReport();
    
    if (tabName === 'tabGraficos') {
        try {
            document.getElementById('yearSelectorChart').value = document.getElementById('yearSelectorBudget').value;
            document.getElementById('chartPeriodSelector').value = document.getElementById('monthSelector').value;
        } catch (e) { console.error("Erro ao sincronizar os seletores:", e); }
        
        setTimeout(() => renderChart(), 50); 
    }
}

function handleExpenseInput(input, item) {
    const year = document.getElementById("yearSelectorBudget").value;
    const month = input.closest("tr").dataset.month;
    appData[year].months[month].expenses[item] = parseFloat(input.value) || 0;
    updateAllStatusPanels();
    saveData();
}

function loadData() { try { appData = JSON.parse(localStorage.getItem('orcamentoAppData')) || {}; } catch (e) { console.error("Falha ao ler localStorage:", e); appData = {}; } if (Object.keys(appData).length === 0) initializeYearData(new Date().getFullYear()); }
function saveData() { try { localStorage.setItem('orcamentoAppData', JSON.stringify(appData)); } catch (e) { console.error("Falha ao salvar no localStorage:", e); } }
function resetAllData() { const confirmation = confirm("ATENÇÃO! Deseja resetar todos os dados? Esta ação é irreversível."); if (confirmation) { try { localStorage.removeItem('orcamentoAppData'); alert("Dados resetados."); location.reload(); } catch (e) { alert("Não foi possível resetar os dados."); } } }
function initializeYearData(year) { if (appData[year]) return; appData[year] = { months: {} }; const defaultIncomes = [{ name: 'Meu Salário', value: 0 }]; const defaultBudgets = [{ name: 'Gasto Fixo', percentage: 60 }, { name: 'Lazer', percentage: 30 }, { name: 'Emergencia', percentage: 10 }]; const defaultItems = { 'Gasto Fixo': ['Água', 'Luz', 'Telefone'], 'Lazer': ['Cinema', 'Bar'], 'Emergencia': ['Emergencia'] }; const defaultExpenses = {}; Object.values(defaultItems).flat().forEach(item => { defaultExpenses[item] = 0; }); months.forEach(month => { appData[year].months[month] = { incomes: JSON.parse(JSON.stringify(defaultIncomes)), budgets: JSON.parse(JSON.stringify(defaultBudgets)), items: JSON.parse(JSON.stringify(defaultItems)), expenses: JSON.parse(JSON.stringify(defaultExpenses)) }; }); }
const formatCurrency = v => isNaN(v) ? "R$ 0,00" : v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
function setupSelectors() { const currentYear = new Date().getFullYear(); const currentMonthName = months[new Date().getMonth()]; const yearsWithData = Object.keys(appData).length > 0 ? Object.keys(appData).sort((a, b) => b - a) : [String(currentYear)]; ['yearSelectorBudget', 'yearSelectorReport', 'yearSelectorChart'].forEach(id => { const selector = document.getElementById(id); selector.innerHTML = ''; yearsWithData.forEach(year => selector.add(new Option(year, year))); selector.value = yearsWithData.includes(String(currentYear)) ? currentYear : yearsWithData[0]; }); const monthSelectorBudget = document.getElementById('monthSelector'); monthSelectorBudget.innerHTML = ''; months.forEach(month => monthSelectorBudget.add(new Option(month, month))); monthSelectorBudget.value = currentMonthName; const chartPeriodSelector = document.getElementById('chartPeriodSelector'); chartPeriodSelector.innerHTML = '<option value="Ano Inteiro">Ano Inteiro</option>'; months.forEach(month => chartPeriodSelector.add(new Option(month, month))); chartPeriodSelector.value = currentMonthName; handleYearChange(); }
function setupChartCategorySelector() { const year = document.getElementById('yearSelectorChart').value; const categorySelector = document.getElementById('chartCategorySelector'); const currentValue = categorySelector.value; categorySelector.innerHTML = '<option value="TODAS">Total por Categoria</option>'; categorySelector.innerHTML += '<option value="TODAS_DETALHADO">Todas as Despesas (Detalhado)</option>'; if (appData[year]) { const allCategories = new Set(); months.forEach(month => { if (appData[year].months[month] && appData[year].months[month].budgets) { appData[year].months[month].budgets.forEach(b => allCategories.add(b.name)); } }); allCategories.forEach(cat => categorySelector.add(new Option(cat, cat))); } categorySelector.value = Array.from(categorySelector.options).some(opt => opt.value === currentValue) ? currentValue : 'TODAS'; }
function handleYearChange() { const year = document.getElementById('yearSelectorBudget').value; if (!appData[year]) initializeYearData(year); displayMonthDetails(); setupChartCategorySelector(); }
function displayMonthDetails() { const year = document.getElementById('yearSelectorBudget').value; const month = document.getElementById('monthSelector').value; if (!appData[year]) { initializeYearData(year); setupSelectors(); return; } const details = appData[year].months[month]; const incomeTbody = document.querySelector("#incomeTable tbody"); const budgetTbody = document.getElementById("budgetBody"); incomeTbody.innerHTML = ""; budgetTbody.innerHTML = ""; details.incomes.forEach(src => addIncomeSource(src.name, src.value, false)); details.budgets.forEach(cat => addBudgetCategory(cat.name, cat.percentage, false)); updateBudgetUI(); buildExpensesTable(); }
function updateBudgetUI() { const year = document.getElementById("yearSelectorBudget").value; const month = document.getElementById("monthSelector").value; const details = appData[year]?.months[month]; if (!details) return; let totalIncome = details.incomes.reduce((s, i) => s + i.value, 0); let totalPercentage = 0; document.querySelectorAll("#budgetBody tr").forEach((row, index) => { const percentage = details.budgets[index]?.percentage || 0; totalPercentage += percentage; row.cells[2].textContent = formatCurrency(totalIncome * (percentage / 100)); }); document.getElementById("totalPercentage").textContent = `${totalPercentage.toFixed(0)}%`; document.getElementById("totalPercentage").style.color = Math.abs(totalPercentage - 100) < 0.01 ? "green" : "red"; document.getElementById("totalMonth").textContent = formatCurrency(totalIncome); }
function updateAllFromBudgetTab(){const year=document.getElementById("yearSelectorBudget").value,selectedMonth=document.getElementById("monthSelector").value,applyToAll=document.getElementById("applyToAllMonthsBudget").checked,newIncomesFromTable=Array.from(document.querySelectorAll("#incomeTable tbody tr")).map(row=>({name:row.cells[0].querySelector("input").value,value:parseFloat(row.cells[1].querySelector("input").value)||0})),newBudgetsFromTable=Array.from(document.querySelectorAll("#budgetBody tr")).map(row=>({name:row.cells[0].querySelector("input").value,percentage:parseFloat(row.cells[1].querySelector("input").value)||0}));if(!appData[year]||!appData[year].months[selectedMonth])return;const oldBudgets=JSON.parse(JSON.stringify(appData[year].months[selectedMonth].budgets));newBudgetsFromTable.forEach((newBudget,index)=>{const oldBudget=oldBudgets[index];if(oldBudget&&newBudget.name!==oldBudget.name){const oldName=oldBudget.name,newName=newBudget.name;months.forEach(monthToUpdate=>{const monthData=appData[year].months[monthToUpdate];if(monthData){const budgetToRename=monthData.budgets.find(b=>b.name===oldName);if(budgetToRename)budgetToRename.name=newName;if(monthData.items&&monthData.items.hasOwnProperty(oldName)){monthData.items[newName]=monthData.items[oldName];delete monthData.items[oldName];}}})}});const monthsToUpdate=applyToAll?months:[selectedMonth];monthsToUpdate.forEach(month=>{const monthData=appData[year].months[month];if(monthData){monthData.incomes=JSON.parse(JSON.stringify(newIncomesFromTable));monthData.budgets=JSON.parse(JSON.stringify(newBudgetsFromTable));const currentItems=monthData.items||{},newItems={};newBudgetsFromTable.forEach(b=>{newItems[b.name]=currentItems[b.name]||[]});monthData.items=newItems}});updateBudgetUI();buildExpensesTable();updateAllStatusPanels();setupChartCategorySelector();saveData();}
function updateAllStatusPanels(){const year=document.getElementById("yearSelectorBudget").value,currentMonth=months[new Date().getMonth()],categoryName=document.getElementById("expenseCategoryFilter").value,globalDetails=appData[year]?.months[currentMonth];if(!globalDetails)return;const totalIncome=globalDetails.incomes.reduce((s,i)=>s+i.value,0),totalSpent=Object.values(globalDetails.expenses).reduce((s,v)=>s+v,0),globalRemaining=totalIncome-totalSpent,globalPanel=document.getElementById("globalStatusPanel");globalPanel.innerHTML=`Resumo do Mês Atual: <strong>${formatCurrency(globalRemaining)} de Saldo</strong>`;globalPanel.className="card ";globalPanel.classList.add(globalRemaining>=0?"global-status-positive":"global-status-negative");const statusPanel=document.getElementById("statusPanel");if("TODAS"===categoryName){globalPanel.style.display="block";statusPanel.style.display="none";}else{globalPanel.style.display="none";statusPanel.style.display="block";const category=globalDetails.budgets.find(b=>b.name===categoryName);if(category){const budgeted=totalIncome*(category.percentage/100),spent=(globalDetails.items[categoryName]||[]).reduce((sum,item)=>sum+(globalDetails.expenses[item]||0),0),remainingCategory=budgeted-spent;statusPanel.innerHTML=`Saldo para ${categoryName}: <strong>${formatCurrency(remainingCategory)}</strong>`;statusPanel.className="card ";const p=remainingCategory/budgeted;if(budgeted>0){if(p<.1){statusPanel.classList.add("status-red");}else if(p<.25){statusPanel.classList.add("status-orange");}else if(p<.5){statusPanel.classList.add("status-yellow");}else if(p<.75){statusPanel.classList.add("status-green-light");}else{statusPanel.classList.add("status-green-strong");}}else{statusPanel.classList.add(remainingCategory<0?"status-red":"status-green-strong");}}}}
function buildExpensesTable(){const header=document.getElementById("expensesHeader"),body=document.getElementById("expensesBody");header.innerHTML="",body.innerHTML="";const year=document.getElementById("yearSelectorBudget").value;if(!appData[year])return;const categoryFilter=document.getElementById("expenseCategoryFilter"),currentFilterValue=categoryFilter.value,allYearCategories=new Set;months.forEach(m=>{if(appData[year].months[m]&&appData[year].months[m].budgets)appData[year].months[m].budgets.forEach(b=>allYearCategories.add(b.name))});const categories=Array.from(allYearCategories);let categoryColors={};categories.forEach((cat,index)=>{categoryColors[cat]=categoryColorPalette[index%categoryColorPalette.length]});categoryFilter.innerHTML='<option value="TODAS">Todas as Categorias</option>';categories.forEach(c=>categoryFilter.add(new Option(c,c)));if(Array.from(categoryFilter.options).some(opt=>opt.value===currentFilterValue)){categoryFilter.value=currentFilterValue}else{categoryFilter.value="TODAS"};const selectedCategoryName=categoryFilter.value,showAll=document.getElementById("showAllMonths").checked,monthsToDisplay=showAll?months:[months[new Date().getMonth()]],allItems=new Set,itemToCategoryMap={};for(const month of months)if(appData[year].months[month]&&appData[year].months[month].items)Object.entries(appData[year].months[month].items).forEach(([cat,items])=>{(items||[]).forEach(item=>itemToCategoryMap[item]=cat)});if("TODAS"===selectedCategoryName){monthsToDisplay.forEach(m=>{if(appData[year].months[m]&&appData[year].months[m].items)Object.values(appData[year].months[m].items).flat().forEach(item=>allItems.add(item))})}else{monthsToDisplay.forEach(m=>{if(appData[year].months[m]&&appData[year].months[m].items&&appData[year].months[m].items[selectedCategoryName])appData[year].months[m].items[selectedCategoryName].forEach(item=>allItems.add(item))})};const items=Array.from(allItems).sort();header.innerHTML=`<tr><th>Mês</th>${items.map(i=>{const itemCategory=itemToCategoryMap[i]||"",color=categoryColors[itemCategory]||"#6c757d",style="TODAS"===selectedCategoryName?`style="border-top:4px solid ${color};padding-top:8px;"`:"",title=`title="Categoria: ${itemCategory}"`;return`<th ${style} ${title}><div class="th-content-wrapper"><div class="header-actions"><button class="item-action-btn edit-btn" onclick="event.stopPropagation();editExpenseItemName('${i}')" title="Renomear '${i}'">✎</button><button class="item-action-btn delete-btn" onclick="event.stopPropagation();removeExpenseItem('${i}')" title="Remover '${i}'">×</button></div><span class="item-name">${i}</span></div></th>`}).join("")}<th><button class="add-item-btn" onclick="addExpenseItem()">+</button></th></tr>`;monthsToDisplay.forEach(month=>{let rowHtml=`<tr data-month="${month}"><td><b>${month}</b></td>`;const monthDetails=appData[year].months[month];if(monthDetails){items.forEach(item=>{const hasItem=Object.values(monthDetails.items||{}).flat().includes(item);if(hasItem){const value=monthDetails.expenses[item]||0;rowHtml+=`<td><input type="number" value="${value>0?value:""}" placeholder="0" oninput="handleExpenseInput(this,'${item}')"></td>`}else{rowHtml+="<td>-</td>"}});rowHtml+="<td></td>"}else{rowHtml+=`<td colspan="${items.length+1}">Dados não disponíveis para este mês.</td>`};body.innerHTML+=`${rowHtml}</tr>`});updateAllStatusPanels()}
function addIncomeSource(name="",value=0,triggerUpdate=!0){document.querySelector("#incomeTable tbody").insertRow().innerHTML=`<td><input type="text" value="${name}"></td><td><input type="number" value="${value>0?value:""}" placeholder="0"></td><td><button class="action-btn-subtle" onclick="removeRow(this)">X</button></td>`;if(triggerUpdate)updateAllFromBudgetTab()}
function addBudgetCategory(name="",percentage=0,triggerUpdate=!0){document.getElementById("budgetBody").insertRow().innerHTML=`<td><input type="text" value="${name}"></td><td><input type="number" value="${percentage>0?percentage:""}" placeholder="0"></td><td></td><td><button class="action-btn-subtle" onclick="removeRow(this)">X</button></td>`;if(triggerUpdate)updateAllFromBudgetTab()}
function removeRow(button){button.closest("tr").remove();updateAllFromBudgetTab()}
function addExpenseItem(){const year=document.getElementById("yearSelectorBudget").value;let categoryName=document.getElementById("expenseCategoryFilter").value;const forAllMonths=document.getElementById("showAllMonths").checked,monthTarget=months[new Date().getMonth()],availableCategories=appData[year].months[monthTarget].budgets.map(b=>b.name);if("TODAS"===categoryName){categoryName=prompt("Em qual categoria deseja adicionar o novo item?\nCategorias disponíveis: "+availableCategories.join(", "),availableCategories[0]||"");if(!categoryName||!availableCategories.includes(categoryName))return void alert("Categoria inválida.")};const promptMessage=forAllMonths?`Adicionar novo item em "${categoryName}" para o ano todo:`:`Adicionar novo item em "${categoryName}" apenas para o mês de ${monthTarget}:`,newItemName=prompt(promptMessage);if(!newItemName||!newItemName.trim())return;const monthsToUpdate=forAllMonths?months:[monthTarget];monthsToUpdate.forEach(month=>{if(appData[year].months[month]&&appData[year].months[month].budgets.some(b=>b.name===categoryName)){appData[year].months[month].items[categoryName]||(appData[year].months[month].items[categoryName]=[]);if(!appData[year].months[month].items[categoryName].includes(newItemName.trim())){appData[year].months[month].items[categoryName].push(newItemName.trim());appData[year].months[month].expenses[newItemName.trim()]=0;}}});saveData();buildExpensesTable()}
function removeExpenseItem(itemName){if(!confirm(`Remover "${itemName}"? A ação removerá o item e todos os seus lançamentos do ano.`))return;const year=document.getElementById("yearSelectorBudget").value;months.forEach(month=>{if(appData[year].months[month]){Object.keys(appData[year].months[month].items).forEach(categoryName=>{appData[year].months[month].items[categoryName]=appData[year].months[month].items[categoryName].filter(i=>i!==itemName)});delete appData[year].months[month].expenses[itemName]}});saveData();buildExpensesTable()}
function editExpenseItemName(oldItemName){const newItemName=prompt("Digite o novo nome para o item:",oldItemName);if(!newItemName||!newItemName.trim()||newItemName.trim()===oldItemName)return;const year=document.getElementById("yearSelectorBudget").value,trimmedNewName=newItemName.trim();months.forEach(month=>{if(appData[year].months[month]){Object.keys(appData[year].months[month].items).forEach(category=>{const itemIndex=appData[year].months[month].items[category].indexOf(oldItemName);if(itemIndex>-1)appData[year].months[month].items[category][itemIndex]=trimmedNewName});if(appData[year].months[month].expenses.hasOwnProperty(oldItemName)){appData[year].months[month].expenses[trimmedNewName]=appData[year].months[month].expenses[oldItemName];delete appData[year].months[month].expenses[oldItemName];}}});saveData();buildExpensesTable();alert(`Item "${oldItemName}" foi renomeado para "${trimmedNewName}" em todo o ano.`)}
function generateAnnualReport(){const year=document.getElementById("yearSelectorReport").value,view=document.getElementById("reportViewSelector").value,container=document.getElementById("reportContainer"),summaryBox=document.getElementById("annual-summary-box");container.innerHTML="",summaryBox.innerHTML="",document.getElementById("reportYearTitle").textContent=`Relatório Anual de ${year}`;if(!appData[year])return void(summaryBox.innerHTML="<p>Nenhum dado para este ano.</p>");let annualIncome=0,annualExpensesTotal=0,annualExpensesByCategory={};const allYearCategories=new Set;months.forEach(m=>{if(appData[year].months[m]&&appData[year].months[m].budgets)appData[year].months[m].budgets.forEach(b=>allYearCategories.add(b.name))});allYearCategories.forEach(c=>annualExpensesByCategory[c]=0);months.forEach(month=>{const details=appData[year].months[month];if(details){annualIncome+=details.incomes.reduce((s,i)=>s+i.value,0);Object.values(details.expenses).forEach(val=>annualExpensesTotal+=val);allYearCategories.forEach(cat=>{const spentInCategory=(details.items[cat]||[]).reduce((s,item)=>s+(details.expenses[item]||0),0);if(void 0!==annualExpensesByCategory[cat])annualExpensesByCategory[cat]+=spentInCategory})}});let summaryHTML=`<h3>Resumo Geral ${year}</h3><p><strong>Receita Total:</strong> ${formatCurrency(annualIncome)}</p><p><strong>Despesa Total:</strong> ${formatCurrency(annualExpensesTotal)}</p><p><strong>Saldo Anual:</strong> <span class="${annualIncome-annualExpensesTotal>=0?"report-balance-positive":"report-balance-negative"}">${formatCurrency(annualIncome-annualExpensesTotal)}</span></p><hr><h4>Despesas Anuais por Categoria</h4><ul>`;Object.entries(annualExpensesByCategory).forEach(([cat,val])=>summaryHTML+=`<li><span>${cat}</span> <span>${formatCurrency(val)}</span></li>`);summaryBox.innerHTML=summaryHTML+"</ul>";if("byCategory"===view){months.forEach(month=>{const details=appData[year].months[month];if(!details)return;const totalIncome=details.incomes.reduce((s,i)=>s+i.value,0);let categoryDetailsHTML="<ul>";details.budgets.forEach(cat=>{const budgeted=totalIncome*(cat.percentage/100),spent=(details.items[cat.name]||[]).reduce((s,item)=>s+(details.expenses[item]||0),0),balance=budgeted-spent;categoryDetailsHTML+=`<li style="margin-top:10px;"><span><strong>${cat.name}</strong></span> <span class="${balance>=0?"":"report-balance-negative"}">Saldo: ${formatCurrency(balance)}</span></li>`;(details.items[cat.name]||[]).forEach(item=>{if(details.expenses[item]>0)categoryDetailsHTML+=`<li style="padding-left:15px;font-size:0.9em;"><span>${item}</span> <span>Gasto: ${formatCurrency(details.expenses[item]||0)}</span></li>`})});categoryDetailsHTML+="</ul>";const monthSpent=Object.values(details.expenses).reduce((s,v)=>s+v,0);container.innerHTML+=`<details><summary>${month}<span class="${totalIncome-monthSpent>=0?"report-balance-positive":"report-balance-negative"}">${formatCurrency(totalIncome-monthSpent)}</span></summary><div class="report-details-content"><div><h4>Receitas</h4><ul>${details.incomes.map(i=>`<li><span>${i.name}</span> <span>${formatCurrency(i.value)}</span></li>`).join("")}</ul></div><div><h4>Análise de Categorias</h4>${categoryDetailsHTML}</div></div></details>`})}else{const allItemsAnnual={};months.forEach(month=>{if(appData[year].months[month])Object.entries(appData[year].months[month].expenses).forEach(([item,val])=>{if(val>0)allItemsAnnual[item]=(allItemsAnnual[item]||0)+val})});let generalHTML="<h3>Despesas Gerais do Ano</h3><ul>";Object.entries(allItemsAnnual).sort(([,a],[,b])=>b-a).forEach(([item,val])=>generalHTML+=`<li><span>${item}</span> <span>${formatCurrency(val)}</span></li>`);container.innerHTML=generalHTML+"</ul>"}}
function renderChart(){if(expenseChartInstance){expenseChartInstance.destroy();expenseChartInstance=null;}const chartContainer=document.getElementById('chartContainer');const canvas=document.getElementById('expenseChart');if(!canvas||chartContainer.offsetParent===null){return;}const ctx=canvas.getContext('2d');ctx.clearRect(0,0,canvas.width,canvas.height);const year=document.getElementById("yearSelectorChart").value;const period=document.getElementById("chartPeriodSelector").value;if(!appData[year]||!appData[year].months[period]&&period!=='Ano Inteiro'){ctx.font="20px Arial";ctx.textAlign="center";ctx.fillText("Nenhum dado para este período.",canvas.width/2,canvas.height/2);return;}const categoryToDetail=document.getElementById("chartCategorySelector").value;const chartType=document.querySelector('input[name="chartType"]:checked').value;let title="";const expenseData={};const monthsToProcess=(period==='Ano Inteiro')?months:[period];if(categoryToDetail==='TODAS'){title=`Total por Categoria - ${period} de ${year}`;const allYearCategories=new Set();monthsToProcess.forEach(m=>{if(appData[year].months[m]&&appData[year].months[m].budgets){appData[year].months[m].budgets.forEach(b=>allYearCategories.add(b.name));}});allYearCategories.forEach(cat=>{expenseData[cat]=0;});monthsToProcess.forEach(month=>{const details=appData[year].months[month];if(details){allYearCategories.forEach(cat=>{const spentInCategory=(details.items[cat]||[]).reduce((sum,item)=>sum+(details.expenses[item]||0),0);expenseData[cat]+=spentInCategory;});}});}else if(categoryToDetail==='TODAS_DETALHADO'){title=`Todas as Despesas (Detalhado) - ${period} de ${year}`;monthsToProcess.forEach(month=>{const details=appData[year].months[month];if(details){Object.entries(details.expenses).forEach(([item,value])=>{if(value>0){expenseData[item]=(expenseData[item]||0)+value;}});}});}else{title=`Detalhamento de Despesas: ${categoryToDetail} - ${period} de ${year}`;monthsToProcess.forEach(month=>{const details=appData[year].months[month];if(details){const itemsInCategory=details.items[categoryToDetail]||[];itemsInCategory.forEach(item=>{const expenseValue=details.expenses[item]||0;if(expenseValue>0){expenseData[item]=(expenseData[item]||0)+expenseValue;}});}});}const labels=Object.keys(expenseData).filter(key=>expenseData[key]>0);const data=labels.map(key=>expenseData[key]);if(data.length===0){ctx.font="20px Arial";ctx.textAlign="center";ctx.fillText("Nenhuma despesa para exibir.",canvas.width/2,canvas.height/2);return;}const backgroundColors=data.map(()=>`rgba(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},0.7)`);if(categoryToDetail==='TODAS'||categoryToDetail==='TODAS_DETALHADO'){let totalPeriodIncome=0;monthsToProcess.forEach(month=>{if(appData[year].months[month]){totalPeriodIncome+=appData[year].months[month].incomes.reduce((s,i)=>s+i.value,0);}});const totalSpentInChart=data.reduce((a,b)=>a+b,0);const remainingBalance=totalPeriodIncome-totalSpentInChart;if(remainingBalance>0.01){labels.push('Saldo Disponível');data.push(remainingBalance);backgroundColors.push('rgba(108,117,125,0.7)');}}Chart.register(ChartDataLabels);expenseChartInstance=new Chart(ctx,{type:chartType,data:{labels:labels,datasets:[{label:'Gasto',data:data,backgroundColor:backgroundColors,borderColor:backgroundColors.map(color=>color.replace('0.7','1')),borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:title,font:{size:18}},legend:{position:'bottom',labels:{generateLabels:function(chart){const data=chart.data;if(data.labels.length&&data.datasets.length){return data.labels.map((label,i)=>{const ds=data.datasets[0];const value=ds.data[i];return{text:`${label}: ${formatCurrency(value)}`,fillStyle:ds.backgroundColor[i],strokeStyle:ds.borderColor[i],lineWidth:ds.borderWidth,hidden:isNaN(ds.data[i]),index:i};});}return[];}}},datalabels:{display:false},tooltip:{callbacks:{label:c=>`${c.label}: ${formatCurrency(c.raw)}`}}}}});}
function downloadExcelTemplate(){const wb=XLSX.utils.book_new(),currentYear=(new Date).getFullYear();XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([["ANO","MÊS","FONTE_RECEITA","VALOR_RECEITA"],[currentYear,"Janeiro","Meu Salário",0]]),"Receitas"),XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([["ANO","CATEGORIA","ITEM_DESPESA_PADRAO"],[currentYear,"Gasto Fixo","Água"],[currentYear,"Gasto Fixo","Luz"],[currentYear,"Gasto Fixo","Telefone"],[currentYear,"Lazer","Cinema"],[currentYear,"Lazer","Bar"],[currentYear,"Emergencia","Emergencia"]]),"Itens_Padrao"),XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([["ANO","MÊS","CATEGORIA","PORCENTAGEM_%"],[currentYear,"Janeiro","Gasto Fixo",60],[currentYear,"Janeiro","Lazer",30],[currentYear,"Janeiro","Emergencia",10]]),"Orcamento_Categorias"),XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([["ANO","MÊS","ITEM_DESPESA","VALOR_GASTO"]]),"Despesas_Realizadas"),XLSX.writeFile(wb,"Modelo_Orcamento.xlsx")}
function importFromExcel(){const fileInput=document.getElementById("importFile");if(!fileInput.files.length)return void alert("Por favor, selecione um arquivo.");const file=fileInput.files[0],reader=new FileReader;reader.onload=function(event){try{const data=new Uint8Array(event.target.result),workbook=XLSX.read(data,{type:"array"});appData={};const wsReceitas=workbook.Sheets.Receitas,receitasJson=XLSX.utils.sheet_to_json(wsReceitas);receitasJson.forEach(r=>{const year=r.ANO,month=r.MÊS;appData[year]||initializeYearData(year),appData[year].months[month].imported_incomes||(appData[year].months[month].incomes=[],appData[year].months[month].imported_incomes=!0),appData[year].months[month].incomes.push({name:r.FONTE_RECEITA,value:r.VALOR_RECEITA})});const wsOrcamento=workbook.Sheets.Orcamento_Categorias,orcamentoJson=XLSX.utils.sheet_to_json(wsOrcamento);orcamentoJson.forEach(o=>{const year=o.ANO,month=o.MÊS;appData[year]||initializeYearData(year),appData[year].months[month].imported_budgets||(appData[year].months[month].budgets=[],appData[year].months[month].imported_budgets=!0),appData[year].months[month].budgets.push({name:o.CATEGORIA,percentage:o["PORCENTAGEM_%"]})});const wsItens=workbook.Sheets.Itens_Padrao,itensJson=wsItens?XLSX.utils.sheet_to_json(wsItens):[];itensJson.forEach(i=>{const year=i.ANO,category=i.CATEGORIA,item=i.ITEM_DESPESA_PADRAO;months.forEach(month=>{if(appData[year]&&appData[year].months[month]){appData[year].months[month].items[category]||(appData[year].months[month].items[category]=[]);if(!appData[year].months[month].items[category].includes(item)){appData[year].months[month].items[category].push(item);appData[year].months[month].expenses[item]=0;}}})});const wsDespesas=workbook.Sheets.Despesas_Realizadas,despesasJson=XLSX.utils.sheet_to_json(wsDespesas);despesasJson.forEach(d=>{const year=d.ANO,month=d.MÊS,item=d.ITEM_DESPESA,value=d.VALOR_GASTO;if(appData[year]&&appData[year].months[month])appData[year].months[month].expenses[item]=value});saveData();alert("Dados importados com sucesso!");document.getElementById("importModal").style.display="none";location.reload()}catch(e){console.error(e);alert("Erro ao importar o arquivo. Verifique se o formato está correto conforme o modelo.")}},reader.readAsArrayBuffer(file)}
function exportToExcel(){const year=document.getElementById("yearSelectorBudget").value;if(!appData[year])return void alert("Nenhum dado para exportar para o ano selecionado.");const receitas=[],orcamento=[],despesas=[];months.forEach(month=>{const details=appData[year].months[month];if(details){details.incomes.forEach(i=>receitas.push([year,month,i.name,i.value]));details.budgets.forEach(b=>orcamento.push([year,month,b.name,b.percentage]));Object.entries(details.expenses).forEach(([item,value])=>{if(value>0)despesas.push([year,month,item,value])})}});const wb=XLSX.utils.book_new(),wsReceitas=XLSX.utils.aoa_to_sheet([["ANO","MÊS","FONTE_RECEITA","VALOR_RECEITA"],...receitas]),wsOrcamento=XLSX.utils.aoa_to_sheet([["ANO","MÊS","CATEGORIA","PORCENTAGEM_%"],...orcamento]),wsDespesas=XLSX.utils.aoa_to_sheet([["ANO","MÊS","ITEM_DESPESA","VALOR_GASTO"],...despesas]);XLSX.utils.book_append_sheet(wb,wsReceitas,"Receitas");XLSX.utils.book_append_sheet(wb,wsOrcamento,"Orcamento_Categorias");XLSX.utils.book_append_sheet(wb,wsDespesas,"Despesas_Realizadas");XLSX.writeFile(wb,`Orcamento_Pessoal_${year}.xlsx`)}
</script>
</body>
</html>
